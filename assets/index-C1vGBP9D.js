(function(){const a=document.createElement("link").relList;if(a&&a.supports&&a.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))e(r);new MutationObserver(r=>{for(const o of r)if(o.type==="childList")for(const s of o.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&e(s)}).observe(document,{childList:!0,subtree:!0});function n(r){const o={};return r.integrity&&(o.integrity=r.integrity),r.referrerPolicy&&(o.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?o.credentials="include":r.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function e(r){if(r.ep)return;r.ep=!0;const o=n(r);fetch(r.href,o)}})();const l="4ace2233e1cb4565918c80fdbfa696d2";async function f(t){const a=h(128),n=await y(a);localStorage.setItem("verifier",a);const e=new URLSearchParams;e.append("client_id",t),e.append("response_type","code"),e.append("redirect_uri","https://nikolajjepsen.github.io/temponizer-jams"),e.append("scope","user-read-private user-read-email user-read-currently-playing user-read-recently-played playlist-modify-public playlist-modify-private playlist-read-collaborative"),e.append("code_challenge_method","S256"),e.append("code_challenge",n),document.location=`https://accounts.spotify.com/authorize?${e.toString()}`}function h(t){let a="",n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";for(let e=0;e<t;e++)a+=n.charAt(Math.floor(Math.random()*n.length));return a}async function y(t){const a=new TextEncoder().encode(t),n=await window.crypto.subtle.digest("SHA-256",a);return btoa(String.fromCharCode.apply(null,[...new Uint8Array(n)])).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}function u(){return localStorage.getItem("access_token")!==null}async function c(){const t=localStorage.getItem("expires_at");return t&&t<Date.now()&&await g(),localStorage.getItem("access_token")}async function g(){const t=localStorage.getItem("refresh_token"),a=new URLSearchParams;a.append("client_id",l),a.append("grant_type","refresh_token"),a.append("refresh_token",t);const n=await fetch("https://accounts.spotify.com/api/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:a}),{access_token:e,expires_in:r}=await n.json();localStorage.setItem("access_token",e),localStorage.setItem("expires_at",r+Date.now())}async function w(t,a){const n=localStorage.getItem("verifier"),e=new URLSearchParams;e.append("client_id",t),e.append("grant_type","authorization_code"),e.append("code",a),e.append("redirect_uri","https://nikolajjepsen.github.io/temponizer-jams"),e.append("code_verifier",n);const r=await fetch("https://accounts.spotify.com/api/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:e}),{access_token:o,expires_in:s,refresh_token:i}=await r.json();localStorage.setItem("access_token",o),localStorage.setItem("expires_at",parseInt(s)*1e3+parseInt(Date.now())),localStorage.setItem("refresh_token",i)}async function k(){let t="[none]",a="N/A";try{const e=await(await fetch("https://api.spotify.com/v1/me/player/currently-playing",{method:"GET",headers:{Authorization:`Bearer ${await c()}`}})).json();t=e.item.name,a=e.item.artists.map(r=>r.name).join(", ")}catch{console.log("No tunes playing")}return{name:t,artists:a}}async function d(){let t=[];try{localStorage.getItem("previous_after")||localStorage.setItem("previous_after",parseInt(Date.now()-60*60*2*1e3));const a=localStorage.getItem("previous_after"),e=await(await fetch("https://api.spotify.com/v1/me/player/recently-played?limit=20&after="+a,{method:"GET",headers:{Authorization:`Bearer ${await c()}`}})).json();e.items.forEach(s=>{t.push({name:s.track.name,artists:s.track.artists.map(i=>i.name).join(", ")})});let r=[];const o=localStorage.getItem("awaits_tracks_registration");if(o)try{const s=JSON.parse(o)}catch{}e.items.forEach(s=>{(!o||!r.includes(s.track.uri))&&r.push(s.track.uri)}),localStorage.setItem("awaits_tracks_registration",JSON.stringify(r))}catch{console.error("No recent tracks")}return t}async function S(){const t=[];try{(await(await fetch("https://api.spotify.com/v1/me/playlists",{method:"GET",headers:{Authorization:`Bearer ${await c()}`}})).json()).items.forEach(e=>{t.push({id:e.id,name:e.name})})}catch{}return t}async function _(t){const a=[];try{(await(await fetch(`https://api.spotify.com/v1/playlists/${t}`,{method:"GET",headers:{Authorization:`Bearer ${await c()}`}})).json()).tracks.items.forEach(r=>{a.push(r.track.uri)})}catch{throw new Error("Failed to fetch playlist tracks")}return a}async function T(t){if(t===0)return;let a=[];try{a=await _(t)}catch{alert("Failed to fetch playlist data for given playlist.");return}const n=localStorage.getItem("awaits_tracks_registration");if(n){const e=JSON.parse(n),r=[];if(e.forEach(o=>{a.includes(o)||r.push(o)}),r)for(let s=0;s<r.length;s+=99){const i=r.slice(s,s+99);await fetch(`https://api.spotify.com/v1/playlists/${t}/tracks`,{method:"POST",headers:{Authorization:`Bearer ${await c()}`,"Content-Type":"application/json"},body:JSON.stringify({uris:i})})}}localStorage.setItem("awaits_tracks_registration","")}async function v(){return await(await fetch("https://api.spotify.com/v1/me",{method:"GET",headers:{Authorization:`Bearer ${await c()}`}})).json()}function I(t){document.getElementById("displayName").innerText=t.display_name}function E(t){document.getElementById("currentTrackName").innerText=t.name,document.getElementById("currentTrackArtist").innerText=t.artists}function m(t){const a=document.getElementById("previousTracks");a.innerHTML="",t.forEach(n=>{const e=document.createElement("li"),r=document.createElement("h3");r.innerText=n.name;const o=document.createElement("p");o.innerText=n.artists,e.appendChild(r),e.appendChild(o),a.appendChild(e)})}function j(t){const a=document.getElementById("playlists");a.innerHTML="";const n=document.createElement("option");n.text="Select playlist",n.value=0,a.appendChild(n),t.forEach(e=>{const r=document.createElement("option");r.text=e.name,r.value=e.id,a.appendChild(r)})}const x=new URLSearchParams(window.location.search),p=x.get("code");u()?await c():p&&await w(l,p);if(u()){document.querySelector("#authenticated").style.display="flex",document.querySelector("#player").style.display="block",document.querySelector("#unauthenticated").style.display="none";const t=await v();I(t);const a=await k();E(a);const n=await d();m(n);const e=await S();j(e)}document.querySelector("#logout").addEventListener("click",()=>{localStorage.clear(),window.location.href="https://nikolajjepsen.github.io/temponizer-jams/"});document.querySelector("#login").addEventListener("click",()=>{f(l)});document.querySelector("#resetPreviousTracks").addEventListener("click",async()=>{localStorage.setItem("previous_after",parseInt(Date.now())),localStorage.setItem("awaits_tracks_registration",""),m(await d())});document.querySelector("#synchronizePlaylist").addEventListener("click",async()=>{const t=document.querySelector("#playlists").value;T(t)});
